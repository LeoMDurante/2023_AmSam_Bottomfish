---
title: "American Samoa Model Checks"
author: "Meg Oshima"
date: "`r Sys.Date()`"
output: html_document
params: 
  species:
    label: "Select species"
    value: APVI
    input: select
    choices: [APRU, APVI, CALU,
    ETCO, LERU, LUKA, PRFL, PRZO, 
    VALO, TEMPLATE_FILES]
  scenario: 
    label: "Scenario"
    value: "base"
    input: text
  report: 
    label: "Model Directory"
    value: "../../SS3 models"
  file_dir:
    label: "file_dir"
    value: "test"
    input: text
  profile:
    label: "profile"
    value: profile
  profile_vec: 
    label: "vector of profile values"
    value: profile.vec
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(this.path)
library(r4ss)
library(ss3diags)


```

**This is a summary report for the `r params$species` `r params$scenario` model run.** 

```{r}

report. <- SS_output(dir = file.path(params$report, params$species, params$file_dir), verbose = FALSE, printstats = FALSE)

```

# Model Output {.tabset}

## Input Data
```{r }
SSplotData(report.)
```

## Convergence Check
```{r}
data.frame(Converged = file.exists(file.path(params$report, params$species, "ss.std")), 
           MaxGrad = report.$maximum_gradient_component)

report.$warnings
```


## Fit to Model {.active}
### CPUE

```{r}
sspar(mfrow = c(1,2))
SSplotIndices(report., subplots = 2, fleets = 1)
SSplotRunstest(report., subplots = "cpue", add = TRUE, indexselect = 1)
sspar(mfrow = c(1,1))
SSplotJABBAres(report., subplots = "cpue", add = TRUE)
```

### Length Comp
```{r}
sspar(mfrow = c(1,2))
SSplotRunstest(report., subplots = "len", add = TRUE, indexselect = 1)
SSplotJABBAres(report., subplots = "len", add = TRUE, indexselect = 1)

SSplotComps(report., subplots = 8, fleets = 1)
SSplotComps(report., subplots = 21, fleets = 1)
SSplotComps(report., subplots = 1, fleets = 1)


```

## Retrospective and Hindcasting  
### Retrospective 
```{r message=FALSE}
if(dir.exists(file.path(params$report, params$species, params$file_dir, "Retrospectives"))){
  
  retro.dirs <- list.files(file.path(params$report, params$species, params$file_dir, "Retrospectives"),
                           full.names = TRUE)
  mod.retro <- SSgetoutput(dirvec = retro.dirs, verbose = FALSE)


retrosum <- SSsummarize(mod.retro, verbose = FALSE)
retrocomp <- SSretroComps(mod.retro)

sspar(mfrow = c(1,2))
SSplotRetro(retrosum,
            subplots = "SSB",
            add = TRUE)

SSplotRetro(retrosum,
            subplots = "F",
            add =TRUE)
}else{
  print("No retrospective runs were found")
}

```

### Hindcasting
```{r }
if(dir.exists(file.path(params$report, params$species, params$file_dir, "Retrospectives"))){
  sspar(mfrow = c(1,2))
SSplotHCxval(retrosum, subplots = "cpue", add = TRUE, indexselect = 1)
SSplotHCxval(retrocomp, subplots = "len", add = TRUE, indexselect = 1)
}else{
  print("No information for hindcast was found")
  
}

```


## Recruitment Deviations 
```{r}
SSplotRecdevs(report., subplots = c(2,3))
```


## Likelihood Profile

```{r eval =FALSE }
if(dir.exists(file.path(params$report, params$species, params$file_dir, paste0(params$profile, "_profile")))){
  r0.vec <- profile.vec
Nprofile <- length(r0.vec)
# read the output files (with names like Report1.sso, Report2.sso, etc.)
profile.dirs <- list.files(file.path(params$report, params$species, params$file_dir, paste0(params$profile, "_profile")),
                           full.names = TRUE)
profilemodels <- SSgetoutput(dirvec = profile.dirs, 
                             keyvec = 1:Nprofile, verbose = FALSE)
# summarize output
profilesummary <- SSsummarize(profilemodels, verbose = FALSE)

# OPTIONAL COMMANDS TO ADD MODEL WITH PROFILE PARAMETER ESTIMATED
MLEmodel <- SS_output(file.path(params$report, params$species), verbose = FALSE, printstats = FALSE)
profilemodels[["MLE"]] <- MLEmodel
profilesummary <- SSsummarize(profilemodels, verbose = FALSE)
# END OPTIONAL COMMANDS

# plot profile using summary created above
SSplotProfile(profilesummary, # summary object
  profile.string = params$profile, # substring of profile parameter
  profile.label = params$profile
)
}else{
  print("No likelihood runs were found")
}



```

## Management Quantities  
```{r eval=FALSE}

mvln <- SSdeltaMVLN(report.)
SSplotEnsemble(mvln$kb, subplots = c("stock", "harvest", "SSB", "F"), add = TRUE)

```


## {-}